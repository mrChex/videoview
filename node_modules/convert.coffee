child_process = require 'child_process'

exports.do = (callback)->
	total_data = ''
	total_time = 0

	encoder = child_process.spawn './convert.sh', ['videos/2.avi']
	encoder.stderr.addListener 'data', (data) ->
		if data
			total_data += data.toString()
			if total_data.toString().match(/Duration:\s\d\d:\d\d:\d\d\.\d\d/)
				time = total_data.toString().match(/Duration:\s(\d\d:\d\d:\d\d\.\d\d)/).toString().substring 10,21
				console.log 'DATA:' + total_data.toString()
				console.log 'Time:' + time
				seconds = parseInt(time.substr 0,2)*3600 + parseInt(time.substr 3,2)*60 + parseInt(time.substr 6,2)
				total_data = ''
				total_time = seconds
				console.log "sec: #{seconds}"

			if data.toString().substr(0,5) == 'frame'
				s = data.toString()

				sm = s.split("time=")[1].split(" ")[0].split(".")[0].split ":"
				sm[0] = sm[0]*360
				sm[1] = sm[1]*60
				sm[2] = parseInt sm[2]
				time = sm[0]+sm[1]+sm[2]

				percent = (time/total_time)*100
				callback percent